# CFMS架构设计

## 1. 实现目标

1. 针对 CTP api 进行 FTDC协议编解码
2. 单机支持 1000 用户全量行情订阅（订阅接口支持模糊匹配）
3. 上游数据源可扩展

## 2. 网络通信

采用asio + socket, 实现异步tcp server。其中asio使用一个异步io_context 管理tcp客户连接和客户端请求， 一个同步io_context处理行情转发。

## 3. 组件逻辑图

![CMFS组件逻辑图](./images/CMFS组件逻辑图.jpg)



## 4. 线程模型

- thread_1: tcpServer, 处理客户请求
- thread_2: 行情发送插件
- thread_3: 用户管理插件， 处理用户登录登出、掉线、行情订阅和取消等事件
- thread_4: udp行情接收线程， 主要用于行情接收和转换， 并更新内存数据
- thread_5: 行情源检测， 定时循环检测行情源连接是否正常并重连
- thread_6: 异步日志

## 5. 功能模块
详细见 [各模块功能列表](./功能列表.md)
1. 网络通信模块
2. 自定义编解码模块
3. 行情接收模块
4. 行情分发模块
5. 用户会话管理模块
6. 基础组件模块（日志、配置）

## 6. 主要功能时序图

- 用户登录时序图  
    ![用户登录时序图](./images/用户登录.png)
- 用户登出时序图  
    ![用户登出时序图](./images/用户登出.png)
- 用户订阅时序图  
    ![用户订阅时序图](./images/行情订阅.png)
- 用户退订时序图  
    ![用户退订时序图](./images/行情退订.png)
- 行情推送时序图  
    ![行情推送时序图](./images/行情推送.png)
